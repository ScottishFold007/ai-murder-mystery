import { Script } from '../types/script';
import { invokeAIStream } from './invoke';

export const qualityCheckStream = (
  script: Script,
  handlers: { onChunk: (t: string) => void; onEnd: () => void; onError: (m: string) => void }
) => {
  const prompt = `你是AI驱动剧本杀生成器质检专家，请对下述完整剧本进行全面评估。

【重要：输出格式要求】
- 必须输出严格的JSON格式结果，不允许任何Markdown标记、解释文本或其他内容
- JSON结构必须完整且有效，所有字符串值必须用双引号包围
- 不要输出代码块标记(\`\`\`)，直接输出纯JSON内容

【JSON输出模板】必须包含以下完整结构：
{
  "scriptTitle": "剧本标题",
  "timestamp": "2024-01-01T12:00:00Z",
  "version": "v2.0",
  "scores": {
    "contentLogic": {
      "score": 数字,
      "details": { "字段名": 数字值, ... }
    },
    "aiExecution": {
      "score": 数字,
      "details": { "字段名": 数字值, ... }
    },
    "playerExperience": {
      "score": 数字,
      "details": { "字段名": 数字值, ... }
    }
  },
  "totalScore": 数字,
  "totalMaxScore": 125,
  "percentage": 数字,
  "grade": "excellent|good|fair|poor",
  "gradeText": "中文等级",
  "issues": [],
  "recommendations": [],
  "summary": "总结文字",
  "recommendationLevel": "推荐说明"
}

【剧本信息】
标题：${script.title}
简介：${script.description}
背景：${script.globalStory}

角色信息：
${script.characters.map((c, i) => `
${i+1}. ${c.name}（${c.roleType||'角色'}）
   - 背景：${c.bio}
   - 性格：${c.personality}
   - 上下文：${c.context}
   - 秘密：${c.secret}
   - 违规原则：${c.violation}
   - 类型标记：${c.isPlayer ? '玩家' : ''}${c.isPartner ? '搭档' : ''}${c.isKiller ? '凶手' : ''}${c.isAssistant ? '助手' : ''}
`).join('\n')}

证物信息：
${script.evidences && script.evidences.length > 0 ? script.evidences.map((e, i) => `
${i+1}. ${e.name}（${e.category}证物）
   - 概况：${e.overview || e.description || '无'}
   - 线索：${e.clues || '无'}
   - 重要程度：${e.importance}
   - 初始状态：${e.initialState}
   - 相关角色：${(e.relatedCharacters || []).join('、') || '无'}
`).join('\n') : '暂无证物信息'}

【JSON字段详细说明和评估标准】

**基础信息字段：**
1. **scriptTitle**: 填入"${script.title}"
2. **timestamp**: 填入当前时间的ISO格式字符串（如"2024-01-01T12:00:00Z"）
3. **version**: 固定填入"v2.0"

**评分字段详细说明：**

**一、内容逻辑层评估 (scores.contentLogic, 总分75分)**

4. **scores.contentLogic.score**: 内容逻辑层总分（0-75分），为以下各项得分之和
5. **scores.contentLogic.details** 各项详细评估（每项按比重计分）：

   **基础与合规类（10分）：**
   - **schemaIntegrity**: JSON字段完整性评估（3分）
     **精确评估标准**:
     * 3分：必需字段100%齐全(title,description,globalStory,characters≥3个,evidences存在)，每个character包含8个必需字段(name,bio,personality,context,secret,violation,roleType,isKiller/isPlayer/isPartner)，每个evidence包含必需字段(name,overview/description,clues,category,importance,initialState,relatedCharacters)
     * 2分：必需字段95%以上齐全，缺失1-2个次要字段
     * 1分：必需字段80%以上齐全，但缺失重要字段
     * 0分：缺失核心字段(title/globalStory/characters/evidences)或characters<3个
   
   - **outputNormalization**: 输出规范性评估（3分）
     **精确评估标准**:
     * 3分：内容100%为纯净剧本文本，无任何元数据标记
     * 2分：内容95%纯净，偶有1-2处格式标记
     * 1分：内容基本纯净，但有明显的系统提示或格式问题
     * 0分：包含大量元数据、代码块标记或系统提示
   
   - **contentSafety**: 内容安全性评估（4分）
     **精确评估标准**:
     * 4分：完全符合内容安全规范，谋杀情节控制适度
     * 3分：基本安全，个别描述稍显激烈但可接受
     * 1-2分：存在轻微安全风险，需要调整部分内容
     * 0分：包含严重违规内容（极端暴力/政治敏感/色情）

   **故事与主题类（15分）：**
   - **worldBuilding**: 世界观清晰度评估（5分）
     **可操作性释义**: 评估description和globalStory是否构建了清晰的故事背景（时间、地点、社会环境），设定是否前后一致，是否有独特的世界观元素（如虚构国家、特殊设定）
     * 优秀(5分)：世界背景独特完整，设定前后一致，细节丰富
     * 良好(4分)：世界背景较清晰，设定基本一致
     * 一般(3分)：世界背景模糊但可理解
     * 差(0-2分)：世界背景混乱或缺失
   
   - **narrativeFlow**: 叙事流畅性评估（5分）
     **可操作性释义**: 检查globalStory的叙事结构是否完整（案件背景→事件发展→现状描述），故事逻辑是否连贯，是否有明确的起承转合，节奏是否适宜
     * 优秀(5分)：开端悬念、中段发展、结局解释连贯自然，节奏把控优秀
     * 良好(4分)：故事脉络清晰，节奏合理
     * 一般(3分)：故事发展可理解但略显突兀
     * 差(0-2分)：故事逻辑混乱，情节跳跃
   
   - **themeDepth**: 主题立意评估（5分）
     **可操作性释义**: 分析故事是否有深层主题（如人性贪婪、复仇、背叛、救赎等），是否通过角色动机和冲突体现主题，是否具有思辨价值而非仅仅是简单的谋杀案
     * 优秀(5分)：主题深刻，探讨人性复杂面，具有思考价值
     * 良好(4分)：主题明确，有一定深度
     * 一般(3分)：主题平常但可接受
     * 差(0-2分)：主题肤浅或缺失

   **角色设计类（25分）：**
   - **characterConsistency**: 角色内部一致性评估（6分）
     **精确评估标准**:
     **字段逻辑一致性（3分）**
     * 3分：每个角色的bio、personality、context、secret之间100%逻辑自洽，无任何矛盾
     * 2分：角色设定95%以上一致，仅有1-2处细微矛盾
     * 1分：角色设定基本合理，但存在明显的逻辑矛盾（如性格与行为不符）
     * 0分：角色设定严重矛盾，如性格温和却行为暴躁、背景贫穷却知识渊博等
     
     **角色可信度（3分）**
     * 3分：每个角色都有合理的成长背景、清晰的行为动机、符合人设的知识结构
     * 2分：大部分角色可信，个别角色略显刻板
     * 1分：角色基本可信但缺乏深度，存在"工具人"倾向
     * 0分：角色设定不可信，明显为了剧情需要而强行设计
   
   - **characterDifferentiation**: 角色区分度评估（8分）
     **精确评估标准**:
     **性格差异度（3分）**
     * 3分：各角色personality字段完全不同，覆盖≥5种不同性格类型（如内向/外向、理性/感性等）
     * 2分：角色性格有明显差异，但存在1-2个相似角色
     * 1分：角色性格有差异但不够突出，同质化倾向明显
     * 0分：角色性格严重雷同，缺乏个性
     
     **动机差异度（3分）**
     * 3分：各角色的核心动机完全不同（如复仇、贪婪、保护、恐惧、野心等），无重叠
     * 2分：动机基本不同，个别角色动机略有相似
     * 1分：存在2-3个角色动机相似或重叠
     * 0分：多个角色动机严重重叠，如都是"来刺杀某人"
     
     **背景差异度（2分）**
     * 2分：各角色社会背景、职业、出身完全不同，形成丰富的社会层次
     * 1分：角色背景有差异但存在重叠
     * 0分：角色背景单一或严重重叠
   
   - **truthConsistency**: 真相一致性评估（6分）
     **精确评估标准**:
     **现场证据解释度（3分）**
     * 3分：凶手的作案手法能100%解释globalStory中的所有现场细节（死因、位置、物证、痕迹等）
     * 2分：能解释90%以上现场情况，个别细节可商榷
     * 1分：能解释主要现场情况，但存在明显漏洞
     * 0分：无法解释关键现场证据，真相与现场严重不符
     
     **时间线自洽度（3分）**
     * 3分：凶手的作案时间、行动轨迹与所有相关角色的时间线完全吻合
     * 2分：时间线基本自洽，存在细微时间差
     * 1分：时间线大体合理但存在逻辑漏洞
     * 0分：时间线混乱，凶手无合理作案机会
   
   - **informationBalance**: 信息价值均衡评估（5分）
     **精确评估标准**:
     * 5分：每个角色都掌握≥2条对破案至关重要的独家信息，证物与角色关联合理，无"无用角色"或"无用证物"
     * 4分：90%以上角色掌握重要信息，大部分证物有推理价值，信息分布相对均衡
     * 3分：80%左右角色有重要信息，证物系统基本完善，个别角色或证物边缘化
     * 2分：60%角色有重要信息，证物系统不够完善，存在明显的信息垄断或无用要素
     * 1分：少数角色垄断关键信息，证物价值不高，大部分角色沦为"工具人"
     * 0分：信息严重不均，证物系统混乱，存在大量无用角色或证物

   **推理公平性与诡计设计类（40分）：**
   - **evidenceSystemIntegrity**: 证物系统完整性评估（5分）
     **精确评估标准**:
     * 5分：证物系统完整，包含≥3个不同类型证物(physical/document/digital/testimony/combination)，每个证物都有完整的overview(物理描述)和clues(关联线索)，证物间形成逻辑链条，重要程度分布合理(critical/high/medium/low)
     * 4分：证物系统较完整，包含≥2个类型证物，大部分证物有overview和clues双重描述，推理价值明确
     * 3分：证物系统基本完整，但部分证物的overview或clues描述不够充分，或重要程度设置不当
     * 2分：证物系统不够完善，存在缺少overview或clues的证物，或证物类型单一
     * 1分：证物系统存在明显缺陷，多数证物缺乏完整描述或推理价值不明
     * 0分：证物系统严重不完整，证物描述混乱或逻辑不清
   
   - **evidenceChain**: 证据链闭环评估（15分）
     **精确评估标准**:
     **步骤1: 动机链验证（5分）**
     * 5分：凶手杀人动机在其他角色的secret/context中有≥3条独立线索支撑，玩家可通过逻辑推导得出
     * 4分：动机有2条线索支撑，推导路径基本清晰
     * 3分：动机有1-2条线索，但需要一定推理跳跃
     * 1-2分：动机线索薄弱，主要依赖凶手自述或单一信息源
     * 0分：动机完全无线索支撑，或只有凶手知道且绝不会透露
     
     **步骤2: 手法链验证（5分）**
     * 5分：特殊作案手法在globalStory或其他角色信息中有≥2条物理线索支撑（如现场痕迹、工具、专业知识等）
     * 4分：手法有1-2条线索支撑，基本可推导
     * 3分：手法线索存在但需要较强推理能力
     * 1-2分：手法缺乏充分线索，主要靠猜测
     * 0分：使用了完全无线索的"神仙手法"
     
     **步骤3: 机会链验证（2分）**
     * 2分：凶手有明确的作案时间窗口，其他角色可验证或推翻不在场证明
     * 1分：作案时间基本合理但存在模糊点
     * 0分：时间线混乱或凶手无合理作案机会
     
     **步骤4: 排除法验证（3分）**
     * 3分：每个非凶手角色都能找到确凿证据打破其动机/手法/机会中的至少一项
     * 2分：大部分非凶手可被排除，个别存在疑点
     * 1分：排除法基本可行但证据不够充分
     * 0分：无法有效排除其他嫌疑人
   
   - **trickDesign**: 诡计设计合理性评估（8分）
     **精确评估标准**:
     **诡计复杂度评估（4分）**
     * 4分：诡计设计巧妙，具有多层次结构（如密室+时间差+伪装），但逻辑合理
     * 3分：诡计有一定复杂性，设计较为巧妙
     * 2分：诡计简单但合理，如直接投毒、伪造不在场证明等
     * 1分：诡计过于简单或略显牵强
     * 0分：诡计不合理或违背物理常识
     
     **诡计线索支撑度（4分）**
     * 4分：每个诡计要素都有≥2条独立线索支撑（物理证据、专业知识、工具痕迹等）
     * 3分：诡计主要要素有线索支撑，个别细节略显突兀
     * 2分：诡计有基本线索但不够充分，需要较强推理能力
     * 1分：诡计线索薄弱，主要靠玩家猜测
     * 0分：使用了完全无线索的"超自然手法"
   
   - **clueAccessibility**: 关键线索可达性评估（8分）
     **精确评估标准**:
     **线索获取路径分析（5分）**
     * 5分：100%关键线索都有≥2种获取路径（角色对话+证物搜查+场景调查+推理分析等）
     * 4分：90%以上关键线索有明确获取路径，证物线索与角色线索相互补充
     * 3分：80%以上关键线索可获取，证物系统提供有效线索支撑
     * 2分：70%左右关键线索可获取，部分证物价值不高或获取困难
     * 1分：关键线索获取路径不足50%，证物系统作用有限
     * 0分：存在只有凶手知道且绝不透露的"死锁信息"，证物无法提供有效线索
     
     **信息分布检查（3分）**
     * 3分：关键线索在至少3个不同角色和证物间合理分布，形成多元化线索网络
     * 2分：关键线索分布在2-3个角色和部分证物间，分布相对均匀
     * 1分：关键线索主要集中在1-2个角色身上，证物作用有限
     * 0分：关键线索被单一角色垄断，证物系统缺失或无效
   
   - **timelineConsistency**: 时间线自洽评估（3分）
     **可操作性释义**: 构建精确的时间线表格，验证所有角色在关键时间点的位置和行为是否自洽。检查凶手是否有明确的作案时间窗口，其他角色的不在场证明是否可被验证或推翻
     * 优秀(3分)：时间线完全自洽，无任何矛盾
     * 良好(2分)：时间线基本自洽，有细微不一致
     * 一般(1分)：时间线大体合理但存在模糊点
     * 差(0分)：时间线混乱或存在严重矛盾
   
   - **alibiVerification**: 不在场证明评估（3分）
     **可操作性释义**: 检查每个非凶手角色的不在场证明是否有证据支持或可被推翻的线索。确保玩家有方法验证或质疑每个人的陈述，避免"无法验证的完美不在场证明"
     * 优秀(3分)：所有不在场证明都可验证或有推翻线索
     * 良好(2分)：大部分不在场证明可验证
     * 一般(1分)：部分不在场证明难以验证但不影响推理
     * 差(0分)：存在无法验证的完美不在场证明

**二、AI执行层评估 (scores.aiExecution, 总分30分)**

6. **scores.aiExecution.score**: AI执行层总分（0-30分）
7. **scores.aiExecution.details** 各项详细评估（每项5分）：

   - **assistantNeutrality**: 助手绝对中立评估（5分）
     **可操作性释义**: 检查isPartner=true的角色是否同时设置了isKiller=true或其他嫌疑人属性，助手的secret和context是否包含偏向性信息，是否能保持客观中立
     * 优秀(5分)：助手角色绝对中立，不兼任嫌疑人或凶手，职责清晰
     * 良好(4分)：助手基本中立，偶有模糊
     * 一般(3分)：助手中立性有疑问
     * 差(0-2分)：助手角色设定有严重问题
   
   - **roleTypeUniqueness**: 角色类型唯一性评估（5分）
     **可操作性释义**: 验证每个角色的isPlayer、isPartner、isKiller、isAssistant字段是否互斥，是否有角色同时具备多个身份标识，或者缺少必要的角色类型
     * 优秀(5分)：isPlayer、isPartner、isKiller字段互斥且明确
     * 良好(4分)：角色类型基本清晰
     * 一般(3分)：角色类型有轻微混淆
     * 差(0-2分)：角色类型严重混乱
   
   - **responsibilityBoundaries**: 职责边界明确评估（5分）
     **可操作性释义**: 检查每个角色的violation字段是否清晰定义了AI不能做什么（如"不能承认杀人"、"不能透露某某秘密"），边界是否具体可执行
     * 优秀(5分)：每个AI角色的violation字段清晰划定行为边界
     * 良好(4分)：职责边界较明确
     * 一般(3分)：职责边界模糊
     * 差(0-2分)：职责边界不清或缺失
   
   - **dialogueFlow**: 对话流程设计评估（5分）
     **可操作性释义**: 评估角色的secret与violation设计是否能产生有层次的对话（愿意说什么、不愿意说什么、在什么情况下可能泄露），是否有足够的审问空间
     * 优秀(5分)：基于秘密和违规原则的对话设计富有层次，交互性强
     * 良好(4分)：对话流程合理
     * 一般(3分)：对话设计平平
     * 差(0-2分)：对话流程有问题
   
   - **informationAccess**: 信息获取路径评估（5分）
     **可操作性释义**: 分析关键破案信息是否通过多个角色的secret、context可获得，是否存在只有凶手知道且绝不会说出的"死锁信息"，玩家是否有现实的获取路径
     * 优秀(5分)：关键信息有明确可达的获取路径
     * 良好(4分)：大部分信息可获取
     * 一般(3分)：部分信息获取困难
     * 差(0-2分)：关键信息难以获取
   
   - **conflictResolution**: 冲突解决机制评估（5分）
     **可操作性释义**: 检查角色间是否存在利益冲突、情感纠葛或信息矛盾，这些冲突是否为玩家提供了"挑拨离间"、"借力打力"的审问策略机会
     * 优秀(5分)：角色间矛盾为玩家提供丰富的审问策略空间
     * 良好(4分)：冲突设计合理
     * 一般(3分)：冲突处理一般
     * 差(0-2分)：冲突设计有问题

**三、玩家体验层评估 (scores.playerExperience, 总分20分)**

8. **scores.playerExperience.score**: 玩家体验层总分（0-20分）
9. **scores.playerExperience.details** 各项详细评估：

   - **informationDistribution**: 信息分布公平性评估（7分）
     **可操作性释义**: 统计每个角色掌握的关键信息数量，检查是否存在"信息垄断"（一个角色掌握过多关键线索）或"无用角色"（角色没有重要信息），评估误导信息的分布是否合理
     * 优秀(7分)：关键线索和误导信息在各嫌疑人间分布极其均衡
     * 良好(5-6分)：信息分布较均衡
     * 一般(3-4分)：信息分布有偏向
     * 差(0-2分)：信息分布严重不均
   
   - **reasoningDifficulty**: 推理难度适中评估（7分）
     **可操作性释义**: 评估推理链长度（需要几步逻辑推演），红鲱鱼数量（误导线索），关键证据的隐蔽程度，综合判断对新手/老手玩家的难度是否适中
     * 优秀(7分)：推理难度适中，既有挑战又不过分复杂
     * 良好(5-6分)：难度基本合适
     * 一般(3-4分)：过简单或过复杂
     * 差(0-2分)：难度设置不当
   
   - **participationGuarantee**: 参与感保证评估（6分）
     **可操作性释义**: 检查每个角色是否都有明确的个人动机、隐藏的秘密、需要防守的信息，是否能在被审问时提供丰富的反应和互动内容，避免"工具人"角色
     * 优秀(6分)：所有角色都有强烈动机和秘密，保证高参与感
     * 良好(4-5分)：大部分角色参与感强
     * 一般(2-3分)：部分角色参与感弱
     * 差(0-1分)：参与感设计不足

**评级和问题分类：**

10. **totalScore**: 三层总分之和（contentLogic + aiExecution + playerExperience）
    **可操作性释义**: 将上述三个层级的得分相加得出总分，但需应用严格扣分规则
11. **totalMaxScore**: 固定120
12. **percentage**: 总分百分比（四舍五入到整数）
    **可操作性释义**: 计算公式为 Math.round(totalScore / totalMaxScore * 100)

**【关键】严格扣分规则 - 必须执行**:
- 如果evidenceChain总分≤5分（证据链严重断裂），则totalScore不得超过60分
- 如果trickDesign中"诡计线索支撑度"≤1分（使用神仙手法），则totalScore不得超过50分  
- 如果clueAccessibility≤3分（关键线索无法获取），则totalScore不得超过65分
- 如果characterDifferentiation中"动机差异度"≤1分（动机严重重叠），则扣除总分10分
- 如果truthConsistency≤2分（真相严重不自洽），则totalScore不得超过55分

13. **grade**: 等级评定
    **可操作性释义**: 根据percentage自动判定等级，基于120分总分的精细化标准
    * excellent: 90-100%（108-120分）（优秀剧本，可直接使用）
    * good: 80-89%（96-107分）（良好剧本，质量较高，稍作调整即可使用）  
    * fair: 70-79%（84-95分）（合格剧本，达到基本要求，需适度改进）
    * poor: 0-69%（0-83分）（不合格剧本，不建议使用，需重大修改）
14. **gradeText**: 中文等级（优秀/良好/合格/不合格）
    **可操作性释义**: 对应grade的中文翻译，使用最新等级标准

15. **issues**: 问题分类数组（具体问题描述）
    **精确分类标准**:
    - **critical**: 致命缺陷（必须修复才能使用）
      * evidenceChain≤5分：证据链严重断裂，推理无法闭环
      * trickDesign线索支撑度≤1分：使用无线索的神仙手法
      * clueAccessibility≤3分：关键线索完全无法获取
      * truthConsistency≤2分：真相与现场证据严重矛盾
      * contentSafety≤2分：包含严重违规内容
      * 角色类型严重混乱（凶手同时是助手等）
    
    - **major**: 主要问题（影响游戏体验，强烈建议修复）
      * evidenceChain 6-10分：证据链存在跳跃或模糊环节
      * characterDifferentiation动机差异度≤1分：多个角色动机重叠
      * informationBalance≤2分：信息分布严重不均
      * trickDesign复杂度≤1分：诡计过于简单或不合理
      * timelineConsistency≤1分：时间线存在严重矛盾
    
    - **minor**: 轻微问题（可优化项，不影响基本游戏）
      * characterConsistency个别角色设定略有矛盾
      * 文本风格不够统一
      * 个别线索获取路径不够清晰
      * 红鲱鱼设计可以更巧妙

16. **recommendations**: 改进建议数组，每项必须包含：
    **可操作性释义**: 针对发现的问题提出具体可执行的改进建议
    - **priority**: 优先级（high/medium/low）
    - **category**: 问题分类（如"时间线"、"角色设计"、"证据链"、"AI交互"等）
    - **description**: 具体问题描述（详细说明发现的问题）
    - **solution**: 建议的解决方案（可操作的改进措施）

17. **summary**: 一句话总体评价（50字以内的精炼总结）
    **可操作性释义**: 基于总分和主要问题，给出简洁的整体评价
18. **recommendationLevel**: 详细的推荐等级说明（100字左右的推荐理由和使用建议）
    **可操作性释义**: 结合评分和问题，详细说明推荐使用情况和改进方向

【关键】JSON输出格式要求：
1. 必须输出完整的JSON对象，包含所有必需字段
2. 所有数值字段必须是数字类型，不能是字符串
3. 所有数组字段（如issues, recommendations）必须存在，即使为空
4. 字段名称必须与规范完全一致，不得遗漏或拼写错误
5. JSON必须以}结尾，确保结构完整

【重要】评分执行要求：
1. 必须严格按照数值标准评分，不允许主观放宽
2. 发现critical问题时，必须应用严格扣分规则
3. 每个评分都要有明确的数值依据，不能凭感觉给分
4. 优先识别和报告致命缺陷，确保问题分类准确
5. 总分计算完成后，必须检查是否符合扣分规则，如不符合则强制调整

请严格按照上述字段说明进行评估，输出完整的JSON结果，确保所有字段都存在：`;

  return invokeAIStream({
    globalStory: prompt,
    sessionId: `qc_${Date.now()}`,
    characterFileVersion: 'quality_checker_v1',
    temperature: 0.1, // 质检需要低温度确保结构化输出的稳定性
    actor: {
      id: -2,
      name: 'ScriptQualityChecker',
      bio: '剧本杀资深质检编辑',
      personality: '严谨、专业、可执行',
      context: '输出结构化JSON格式质检报告',
      secret: '',
      violation: '只输出JSON格式报告，不要任何解释或Markdown',
      image: '',
      messages: [{ role: 'user', content: '请开始对当前剧本进行全面质检，并以JSON格式流式输出报告。' }]
    } as any,
    onChunk: handlers.onChunk,
    onEnd: handlers.onEnd,
    onError: handlers.onError,
  });
};

